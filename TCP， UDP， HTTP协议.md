# TCP， UDP， HTTP协议

两个进程在计算机内部通信，可以有管道，内存共享，信号量，消息队列等方法。

在本地通过PID来唯一标识一个进程。

在网络中， IP层的ip地址可以唯一标识一台主机， TCP层的协议和端口号可以唯一标识唯一主机上的一个进程，这种将IP地址+协议+端口号唯一标识网络中的一个进程

在 OSI 的七层协议中，第二层（数据链路层）的数据叫「Frame」，第三层（网络层）上的数据叫「Packet」，第四层（传输层）的数据叫「Segment」

## TCP

TCP 报文分为TCP首部和数据部分两部分组成

![TCP 首部的组成](http://om6ayrafu.bkt.clouddn.com/post/understand-tcp-udp/CFC6314E4B2FD039C450821D946E93E2.png)

### 源端口和目标端口

各占2个字节，共四个字节，每个字节占8位。

### 序号Seq

占4个字节，TCP 是面向字节流的，在一个 TCP 连接中传输的字节流中的每个字节都按照顺序编号。
例如 100 kb 的 HTML 文档数据，一共 102400 (100 * 1024) 个字节，那么每一个字节就都有了编号，整个文档的编号的范围是 0 ~ 102399。

序号字段值指的是'本报文段' 所发送的数据的第一个字节的序号。

TCP协议是面向字节流的，发送是按照字段发送的。将100kb的文档分割成四等分后，第一个TCP字段包含的是25kb数据，即0-25599字节，该报文的序号值就是0.第二个TCP字段包含的是第25600-51199字节，该报文的值就是25600

根据8位一个字节，四个字节可以表示的范围是[0~2^32]，一共4294967296个序号，当序号增大到最大值时，下个序号回到0.

TCP协议可以对4GB的数据进行编号，在一般情况下，可以保证当序号重复使用时， 旧序号早已经到达网络终点或丢失了。 

###确认号ACK

占4个字节，表示期望收到对方下一个报文段的序号值。

TCP 的可靠性，是建立在「每一个数据报文都需要确认收到」的基础之上的。
就是说，通讯的任何一方在收到对方的一个报文之后，都要发送一个相对应的「确认报文」，来表达确认收到。
那么，确认报文，就会包含确认号。
例如，通讯的一方收到了第一个 25kb 的报文，该报文的 序号值=0，那么就需要回复一个**确认报文**，其中的确认号 = 25600.

### 数据偏移Offset

占0.5个字节，4位。

这个字段实际上是指出了 TCP 报文段的首部长度，它指出了 TCP报文段的数据起始处 距离 TCP报文的起始处 有多远。（注意 数据起始处 和 报文起始处 的意思）

一个数据偏移量 = 4 byte，由于 4 位二进制数能表示的最大十进制数字是 15，因此数据偏移的最大值是 60 byte，这也侧面限制了 TCP 首部的最大长度

### 保留Reserved

占0.75个字节6位。

保留为今后使用，目前置为0	

### 标志位TCP Flags

标志位，一共有 6 个，分别占 1 位，共 6 位 。
每一位的值只有 0 和 1，分别表达不同意思

- #### 紧急 URG (Urgent)

  当 URG = 1 的时候，表示紧急指针（Urgent Pointer）有效。
  它告诉系统此报文段中有紧急数据，应尽快传送，而不要按原来的排队顺序来传送。
  URG 要与首部中的 紧急指针 字段配合使用

- #### 确认 ACK (Acknowlegemt)

  当 ACK = 1 的时候，确认号（Acknowledgemt Number）有效。
  一般称携带 ACK 标志的 TCP 报文段为「确认报文段」。
  TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 设置为 1

- #### 推送 PSH (Push)

  当 PSH = 1 的时候，表示该报文段高优先级，接收方 TCP 应该尽快推送给接收应用程序，而不用等到整个 TCP 缓存都填满了后再交付

- #### 复位 RST (Reset)

  当 RST = 1 的时候，表示 TCP 连接中出现严重错误，需要释放并重新建立连接。
  一般称携带 RST 标志的 TCP 报文段为「复位报文段」

- #### 同步 SYN (SYNchronization)

  当 SYN = 1 的时候，表明这是一个请求连接报文段。
  一般称携带 SYN 标志的 TCP 报文段为「同步报文段」。
  在 TCP 三次握手中的第一个报文就是同步报文段，在连接建立时用来同步序号。
  对方若同意建立连接，则应在响应的报文段中使 SYN = 1 和 ACK = 1

- #### 终止 FIN (Finis)

  当 FIN = 1 时，表示此报文段的发送方的数据已经发送完毕，并要求释放 TCP 连接。
  一般称携带 FIN 的报文段为「结束报文段」。
  在 TCP 四次挥手释放连接的时候，就会用到该标志

### 窗口大小WS

占 2 字节。
该字段明确指出了现在允许对方发送的数据量，它告诉对方本端的 TCP 接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。
窗口大小的值是指，从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。
例如，假如确认号是 701 ，窗口字段是 1000。这就表明，从 701 号算起，发送此报文段的一方还有接收 1000 （字节序号是 701 ~ 1700） 个字节的数据的接收缓存空间

### 校验和 TCP Checksum

占 2 个字节。
由发送端填充，接收端对 TCP 报文段执行 CRC 算法，以检验 TCP 报文段在传输过程中是否损坏，如果损坏这丢弃。
检验范围包括首部和数据两部分，这也是 TCP 可靠传输的一个重要保障。

### 紧急指针Urgent Pointer

占 2 个字节。
仅在 URG = 1 时才有意义，它指出本报文段中的紧急数据的字节数。
当 URG = 1 时，发送方 TCP 就把紧急数据插入到本报文段数据的**最前面**，而在紧急数据后面的数据仍是普通数据。
因此，紧急指针指出了紧急数据的末尾在报文段中的位置



![TCP 的三次握手和四次挥手](http://om6ayrafu.bkt.clouddn.com/post/understand-tcp-udp/08EAF7F3E7FFCEF3E781385BF62BA2BC.png)



**四次挥手的原因在于在关闭状态中有个半关闭的概念**

这个概念是说，TCP 的连接是全双工（可以同时发送和接收）的连接，因此在关闭连接的时候，必须关闭传送和接收两个方向上的连接。
客户端给服务器发送一个携带 FIN 的 TCP 结束报文段，然后服务器返回给客户端一个 确认报文段，同时发送一个 结束报文段，当客户端回复一个 确认报文段 之后，连接就结束了

















